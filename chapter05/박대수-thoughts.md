# Google Spanner: Paxos와 TrueTime 요약 및 고찰

이 문서는 Google Spanner의 핵심 기술인 Paxos와 TrueTime에 대한 분석을 정리한 것입니다.

## 1. 개요
Google Spanner는 전 세계 데이터 센터에 걸쳐 데이터를 샤딩하고 복제하면서도 **외부 일관성(External Consistency)**을 보장하는 글로벌 분산 데이터베이스입니다. CAP 이론상 CP 시스템에 해당하지만, 99.999% 이상의 고가용성을 제공합니다. 이를 위해 Spanner는 **2PC(Two-Phase Commit)**, **Paxos**, 그리고 **TrueTime**을 결합하여 사용합니다.

## 2. Paxos 활용
Spanner는 복제본 간의 합의를 위해 리더 기반의 Paxos 알고리즘을 사용합니다.
- **Paxos Group**: 데이터의 복제본 세트는 하나의 Paxos 그룹으로 관리됩니다.
- **Leader Lease**: 성능 최적화를 위해 특정 기간(예: 10초) 동안 권한을 갖는 리더를 선출하며, 리더는 이 기간 내에 트랜잭션을 주도합니다.
- **분산 트랜잭션**: 여러 Paxos 그룹에 걸친 트랜잭션은 그룹 리더들이 코디네이터가 되어 2PC를 수행합니다.

## 3. Google TrueTime (핵심 개념)
분산 시스템에서 가장 어려운 문제 중 하나인 '이벤트의 순서 결정'을 해결하기 위해 도입된 전역 동기화 시계입니다.

### 3.1. 도입 배경
- 일반적인 서버의 시계는 **Drift 현상**(온도 등에 의해 빨라지거나 느려짐)이 발생하며, NTP 동기화는 네트워크 지연으로 인해 정확도에 한계가 있습니다.
- Google은 하드웨어 수준에서 시계 오차 범위를 제어할 수 있는 시스템인 TrueTime을 구축했습니다.

### 3.2. TrueTime의 구조와 작동 원리
- **Time Sources**: GPS와 **원자시계(Atomic Clock)**라는 서로 다른 실패 모드를 가진 두 소스를 함께 사용합니다. GPS는 안테나 장애 등에 취약할 수 있고, 원자시계는 주파수 오류가 발생할 수 있어 상호 보완적입니다.
- **Time Master**: 각 데이터 센터마다 GPS 수신기나 원자시계를 가진 마스터 노드들이 존재하며, 이들은 서로의 시간을 비교하여 비정상적인 노드를 제외합니다.
- **API (Interval 기반 시간)**: `TT.now()`를 호출하면 단일 값이 아닌 **오차 범위를 포함한 구간 `[earliest, latest]`**를 반환합니다. 
    - 이 구간은 현재 실제 시간이 반드시 포함되어 있음을 보장하는 범위입니다.
    - 오차(`epsilon`)는 주로 시계의 drift와 마스터와의 통신 지연에 의해 결정됩니다.

### 3.3. 외부 일관성(External Consistency) 달성
- **Commit Wait**: Spanner의 핵심적인 기법입니다. 트랜잭션 $T_1$이 시간 $s_1$에 커밋되었다면, 이후에 시작된 $T_2$의 커밋 시간 $s_2$는 반드시 $s_1$보다 커야 합니다.
- 이를 보장하기 위해 리더는 트랜잭션 커밋 요청을 받으면, **TrueTime의 오차 범위(`latest - earliest`)만큼 의도적으로 기다린 후(Commit Wait)** 결과를 클라이언트에게 반환합니다. 
- 이 기다림 덕분에 서로 다른 지역의 서버라도 타임스탬프만으로 트랜잭션의 인과 관계를 완벽하게 정의할 수 있게 됩니다.

### 3.4. MVCC(Multi-Version Concurrency Control)
- TrueTime이 제공하는 단조 증가하는 타임스탬프 덕분에 Spanner는 잠금 없는(Lock-free) 읽기 트랜잭션을 구현합니다.
- 특정 과거 시점의 타임스탬프로 데이터를 읽을 때, TrueTime 덕분에 해당 시점까지의 모든 쓰기가 완료되었음을 확신할 수 있습니다.

## 4. 고찰
기존의 분산 시스템들이 논리적 시계(Logical Clock)나 벡터 시계(Vector Clock)를 통해 인과 관계를 추적하려 했던 것과 달리, Google은 **하드웨어(GPS, 원자시계)와 소프트웨어(Commit Wait)를 결합**하여 물리적 시간을 신뢰할 수 있는 자원으로 만들었다는 점이 매우 혁신적입니다. 비록 Commit Wait로 인해 약간의 지연(Latency)이 발생하지만, 이를 통해 얻는 강력한 일관성과 개발 편의성은 글로벌 서비스 운영에 있어 압도적인 이점을 제공한다고 생각합니다.
