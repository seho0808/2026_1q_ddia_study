# 컬럼 지향 저장소의 인덱스 활용 아이디어

컬럼 지향 저장소에 인덱스를 추가해서 굳이 파일 별로 엄격하게 순서를 맞추지 않아도 인덱스 컬럼하고 같이 조회하면 찾을 수 있게 하면 어떨까? 그러면 행 지향과 컬럼 지향의 장점을 함께 가질 수 있지 않을까?

**위 아이디어는 현대적인 OLAP 엔진(ClickHouse, Apache Parquet 등)과 HTAP(Hybrid Transactional/Analytical Processing) 시스템이 실제로 채택하고 있는 매우 핵심적인 접근 방식.**

하지만 말씀하신 대로 "파일 별로 순서를 맞추지 않고 인덱스로만 연결"할 경우 발생하는 물리적 한계가 존재함.

## 장점 (Hybrid 효과)

- **유연한 데이터 삽입**: 데이터가 들어오는 대로 아무 파일에나 적재하고 인덱스만 갱신하면 되므로 쓰기 부하가 줄어듦듦.
- **부분 선택적 조회**: 인덱스를 통해 특정 행(Row)의 위치를 찾고, 필요한 컬럼만 골라 읽을 수 있어 행 지향의 검색 속도와 컬럼 지향의 효율성을 동시에 노릴 수 있음음.

## 현실적인 문제점 (왜 여전히 순서가 중요한가?)

인덱스만으로 해결하려고 할 때 가장 큰 걸림돌은 **디스크 I/O와 압축률**.

- **데이터 무작위 접근 (Random Access)**: 컬럼 지향의 가장 큰 장점은 "연속된 메모리/디스크 블록을 한꺼번에 읽는 것"임. 데이터가 파일마다 흩어져 있으면 인덱스로 위치를 찾아도 디스크 헤더가 여기저기 뛰어다녀야 하므로 성능이 급격히 떨어짐.

- **압축 효율 급락**: 컬럼 지향은 비슷한 데이터(예: 날짜, 상태값)가 정렬되어 모여 있을 때 압축률이 10배 이상 높아집니다. 순서 없이 섞이면 압축 효율이 떨어져 저장 용량이 늘어남.

- **인덱스 오버헤드**: 모든 데이터의 위치를 인덱스로 관리하면, 데이터보다 인덱스 크기가 더 커지는 배보다 배꼽이 더 큰 상황이 발생할 수 있습니다.

## 실제 기술들은 어떻게 해결하고 있을까?

그래서 최신 시스템들은 위 아이디어를 **'블록(Block) 단위 정렬'과 '희소 인덱스(Sparse Index)'로 보완하여 사용함**.

- **LSM 트리 기반 컬럼 저장 (예: ClickHouse)**: 데이터를 완전히 무작위로 두지 않고, 작은 단위(예: 8,192개 행)로 묶어서 그 안에서만 정렬을 유지함. 그리고 각 묶음의 최소/최대값만 인덱스로 관리함.

- **Parquet/ORC 파일 포맷**: 파일을 Row Group이라는 단위로 쪼개고, 각 그룹 내에서만 컬럼별로 모아서 저장함. 인덱스는 각 그룹의 시작점만 가리킴.

- **Projection (Vertica 등)**: 동일한 데이터를 서로 다른 정렬 순서를 가진 여러 파일로 복제하여 저장합니다. 쿼리에 따라 가장 유리한 정렬 순서의 파일을 선택해 읽음.

## 요약

"인덱스를 활용한 유연한 저장"은 괜찮은 아이디어지만, 성능을 위해서는 결국 물리적인 정렬(SSTable 방식의 핵심)을 완전히 포기하기 어려움. 그래서 현대 DB는 **'느슨한 정렬(정렬된 블록들의 집합)' + '메타데이터 인덱스'**를 조합하는 방식을 주로 사용함.
