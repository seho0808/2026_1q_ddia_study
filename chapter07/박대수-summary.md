# Chapter 07: 트랜잭션

## 트랜잭션 ACID

트랜잭션은 데이터베이스의 상태를 변경하는 논리적 작업 단위로, ACID 속성을 보장합니다:

### Atomicity (원자성)
- 트랜잭션 내의 모든 작업이 모두 성공하거나 모두 실패하는 것을 보장
- 부분적인 실행 상태가 남지 않음
- 예: 은행 송금에서 출금과 입금이 모두 성공하거나 모두 실패

### Consistency (일관성)
- 트랜잭션이 실행되기 전과 후에 데이터베이스가 일관된 상태를 유지
- 데이터베이스의 무결성 제약 조건을 위반하지 않음
- 애플리케이션 수준의 일관성 보장

### Isolation (격리성)
- 동시에 실행되는 트랜잭션들이 서로의 실행에 영향을 미치지 않음
- 각 트랜잭션은 다른 트랜잭션이 존재하지 않는 것처럼 실행됨
- 격리 수준에 따라 다른 트랜잭션의 변경사항을 어느 정도 볼 수 있는지가 결정됨

### Durability (지속성)
- 트랜잭션이 성공적으로 커밋되면 그 결과가 영구적으로 저장됨
- 시스템 장애가 발생하더라도 커밋된 트랜잭션의 결과는 유지됨

## 단일 객체 연산 vs 다중 객체 연산

### 단일 객체 연산
- 하나의 데이터베이스 객체(행, 문서 등)에 대한 작업
- 대부분의 데이터베이스에서 원자성과 격리성을 쉽게 보장 가능
- 예: 단일 행 업데이트, 단일 문서 저장

### 다중 객체 연산
- 여러 데이터베이스 객체에 걸친 작업
- ACID 보장을 위해 더 복잡한 메커니즘 필요
- 예: 여러 계좌 간 송금, 주문과 재고 동시 업데이트

다중 객체 트랜잭션에서는 단일 객체 연산보다 더 많은 조율과 동기화가 필요합니다.

## 읽기 스큐와 쓰기 스큐

### 읽기 스큐 (Read Skew)
- 트랜잭션이 다른 트랜잭션의 커밋되지 않은 변경사항을 읽는 현상
- "더티 읽기"라고도 불림
- 예: 계좌 잔고 확인 중 다른 트랜잭션의 송금 작업이 진행 중일 때

### 쓰기 스큐 (Write Skew)
- 두 트랜잭션이 서로 다른 객체를 읽고 쓰되, 서로의 변경사항이 겹치는 상황
- 각 트랜잭션은 다른 트랜잭션의 존재를 모르고 실행됨
- 예: 회의실 예약 시스템에서 두 사람이 동시에 같은 시간대의 빈 회의실을 예약

쓰기 스큐는 더티 쓰기나 쓰기 손실과 다르게, 각 트랜잭션이 다른 객체를 수정하지만 논리적 불일치를 초래합니다.

## 직렬 실행

직렬 실행은 트랜잭션들을 순차적으로 하나씩 실행하는 방식으로, 동시성 문제를 근본적으로 해결합니다.

### 장점
- 정확성 보장: 복잡한 격리 수준 설정 없이 올바른 결과 보장
- 디버깅 용이: 트랜잭션이 순차적으로 실행되므로 예측 가능

### 단점
- 성능 저하: 동시성이 제한되어 처리량 감소
- 실제 구현의 어려움: 모든 트랜잭션을 단일 스레드에서 실행하기 어려움

### 구현 방식
1. **단일 스레드 실행**: 모든 트랜잭션을 큐에 넣고 순차적으로 처리
2. **저장 프로시저**: 애플리케이션 로직을 데이터베이스 내에 저장하여 실행
3. **파티셔닝**: 데이터를 파티션으로 나누어 각 파티션에서 직렬 실행

## 2단계 잠금 (Two-Phase Locking, 2PL)

2단계 잠금은 트랜잭션이 객체에 대한 잠금을 얻는 과정을 두 단계로 나누는 방식입니다.

### 성장 단계 (Growing Phase)
- 트랜잭션이 필요한 잠금을 모두 획득
- 새로운 잠금을 얻을 수 있지만 이미 가진 잠금은 해제할 수 없음

### 축소 단계 (Shrinking Phase)
- 트랜잭션이 잠금을 해제하기 시작
- 새로운 잠금을 얻을 수 없고 기존 잠금만 해제 가능

### 잠금 종류
- **공유 잠금 (Shared Lock, S-Lock)**: 읽기용, 여러 트랜잭션이 동시에 획득 가능
- **배타 잠금 (Exclusive Lock, X-Lock)**: 쓰기용, 한 번에 하나의 트랜잭션만 획득 가능

### 잠금 호환성
- S-Lock은 다른 S-Lock과 호환되지만 X-Lock과 호환되지 않음
- X-Lock은 다른 어떤 잠금과도 호환되지 않음

### 장점
- 직렬성 보장: 2PL을 따르는 스케줄은 항상 직렬 가능
- 간단한 구현: 많은 데이터베이스에서 기본 격리 수준으로 사용

### 단점
- 교착상태 발생 가능성: 트랜잭션들이 서로의 잠금을 기다리는 상황
- 성능 저하: 동시성이 제한되어 대기 시간이 증가